worker_processes auto;
error_log logs/error.log info;
pid logs/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include mime.types;
    default_type application/json;

    log_format main '$remote_addr [$time_local] "$request" $status request_id=$http_x_request_id';
    access_log logs/access.log main;

    lua_shared_dict rate_limit_cache 10m;

    upstream public_server {
        server 127.0.0.1:8001 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }

    upstream admin_server {
        server 127.0.0.1:8002 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }

    server {
        listen 8080;
        server_name localhost;

        location /health {
            access_log off;
            return 200 '{"status":"healthy"}\n';
            add_header Content-Type application/json;
        }

        location /api/auth/ {
            access_by_lua_block {
                local redis = require "resty.redis"
                local red = redis:new()
                red:set_timeouts(1000, 1000, 1000)
                if red:connect("127.0.0.1", 6380) then
                    local key = "rate_limit:auth:" .. ngx.var.binary_remote_addr
                    local count = red:incr(key)
                    if count == 1 then red:expire(key, 60) end
                    if count > 5 then
                        return ngx.redirect("https://www.telkomsel.com/internetbaik")
                    end
                    red:close()
                end
            }
            proxy_pass http://public_server;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /api/payment/ {
            access_by_lua_block {
                local redis = require "resty.redis"
                local red = redis:new()
                if red:connect("127.0.0.1", 6380) then
                    local user_id = ngx.var.http_x_user_id or ngx.var.binary_remote_addr
                    local key = "rate_limit:payment:" .. user_id
                    local count = red:incr(key)
                    if count == 1 then red:expire(key, 60) end
                    if count > 100 then
                        ngx.status = 429
                        ngx.say('{"error":"Rate limit exceeded"}')
                        return ngx.exit(429)
                    end
                    red:close()
                end
            }
            proxy_pass http://public_server;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /api/admin/ {
            access_by_lua_block {
                local redis = require "resty.redis"
                local red = redis:new()
                if red:connect("127.0.0.1", 6380) then
                    local key = "rate_limit:admin:" .. ngx.var.binary_remote_addr
                    local count = red:incr(key)
                    if count == 1 then red:expire(key, 60) end
                    if count > 120 then
                        ngx.status = 429
                        ngx.say('{"error":"Rate limit exceeded"}')
                        return ngx.exit(429)
                    end
                    red:close()
                end
            }
            proxy_pass http://admin_server;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location = /favicon.ico {
            log_not_found off;
            access_log off;
            return 204; # Return No Content
        }        
    }
}
